{% extends "base.html" %}
{% block title %}Admin Dashboard - {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-4 mb-3">
    <h1 class="mb-0">Admin Dashboard</h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('results') }}" class="btn btn-outline-primary">View Results</a>
        <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-secondary">Logout</a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        Add New Candidate
    </div>
    <div class="card-body">
        <form class="row g-3 align-items-end" method="post" action="{{ url_for('add_candidate') }}">
            <div class="col-md-5">
                <label for="year" class="form-label">Class Year</label>
                <select name="year" id="year" class="form-select" required>
                    <option value="Freshman">Freshman</option>
                    <option value="Sophomore">Sophomore</option>
                    <option value="Junior">Junior</option>
                    <option value="Senior">Senior</option>
                </select>
            </div>
            <div class="col-md-5">
                <label for="name" class="form-label">Candidate Name</label>
                <input type="text" name="name" id="name" class="form-control" required>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-success">Add</button>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        Manage Candidates
    </div>
    <div class="card-body">
        {% for year, names in candidates.items() %}
            <h5 class="mt-3">{{ year }}</h5>
            {% if names %}
            <ul class="list-group">
                {% for name in names %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ name }}
                    <form method="post" action="{{ url_for('delete_candidate') }}">
                        <input type="hidden" name="year" value="{{ year }}">
                        <input type="hidden" name="name" value="{{ name }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No candidates listed for this year.</p>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        Manually Cast Vote
    </div>
    <div class="card-body">
        <form method="post" action="{{ url_for('manual_vote') }}">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="email" class="form-label">Student Email</label>
                    <input type="email" name="email" id="email" class="form-control" placeholder="student_email@student.csuniv.edu" required>
                </div>
                <div class="col-md-6">
                    <label for="manual_vote_year" class="form-label">Class Year</label>
                    <select name="year" id="manual_vote_year" class="form-select" required>
                        <option value="Freshman">Freshman</option>
                        <option value="Sophomore">Sophomore</option>
                        <option value="Junior">Junior</option>
                        <option value="Senior">Senior</option>
                    </select>
                </div>
            </div>
            <hr class="my-4">
            <h5>Select Candidates (up to 10)</h5>
            <p class="text-muted mb-2">Selected: <span id="selected-count">0</span>/10</p>
            <div id="candidate_checkbox_wrapper" class="mb-3"></div>
            <div class="mb-3">
                <label for="write_in_name" class="form-label fw-bold">Write-in Candidate (Optional)</label>
                <input type="text" class="form-control" name="write_in_name" id="write_in_name" placeholder="Enter a name">
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Submit Vote</button>
            </div>
        </form>
    </div>
</div>

<script>
    const candidates = {{ candidates | tojson }};
    const yearSelect = document.getElementById('manual_vote_year');
    const checkboxWrapper = document.getElementById('candidate_checkbox_wrapper');

    const MAX_SELECTIONS = 10;

    function updateSelectionState() {
        const selected = checkboxWrapper.querySelectorAll('input[type="checkbox"]:checked').length;
        document.getElementById('selected-count').textContent = selected;
        const disableUnchecked = selected >= MAX_SELECTIONS;
        checkboxWrapper.querySelectorAll('input[type="checkbox"]').forEach((input) => {
            if (!input.checked) {
                input.disabled = disableUnchecked;
            }
        });
    }

    function updateCandidateCheckboxes() {
        const selectedYear = yearSelect.value;
        const yearCandidates = candidates[selectedYear] || [];
        
        checkboxWrapper.innerHTML = ''; // Clear previous checkboxes
        
        if (yearCandidates.length > 0) {
            yearCandidates.forEach((candidate, index) => {
                const div = document.createElement('div');
                div.className = 'form-check fs-5 my-2';
                
                const input = document.createElement('input');
                input.className = 'form-check-input';
                input.type = 'checkbox';
                input.name = 'candidates';
                input.value = candidate;
                input.id = `manual-candidate-${index}`;
                input.addEventListener('change', updateSelectionState);
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `manual-candidate-${index}`;
                label.textContent = candidate;
                
                div.appendChild(input);
                div.appendChild(label);
                checkboxWrapper.appendChild(div);
            });
        } else {
            checkboxWrapper.innerHTML = '<p class="text-muted">No candidates for this year.</p>';
        }
        updateSelectionState();
    }

    yearSelect.addEventListener('change', updateCandidateCheckboxes);
    document.addEventListener('DOMContentLoaded', updateCandidateCheckboxes);
</script>
{% endblock %}
