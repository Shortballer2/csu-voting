{% extends "base.html" %}
{% block title %}Admin Dashboard - {{ super() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mt-4 mb-3">
    <h1>Admin Dashboard</h1>
    <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-secondary">Logout</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        Add New Candidate
    </div>
    <div class="card-body">
        <form class="row g-3 align-items-end" method="post" action="{{ url_for('add_candidate') }}">
            <div class="col-md-5">
                <label for="year" class="form-label">Class Year</label>
                <select name="year" id="year" class="form-select" required>
                    <option value="Freshman">Freshman</option>
                    <option value="Sophomore">Sophomore</option>
                    <option value="Junior">Junior</option>
                    <option value="Senior">Senior</option>
                </select>
            </div>
            <div class="col-md-5">
                <label for="name" class="form-label">Candidate Name</label>
                <input type="text" name="name" id="name" class="form-control" required>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-success">Add</button>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        Manage Candidates
    </div>
    <div class="card-body">
        {% for year, names in candidates.items() %}
            <h5 class="mt-3">{{ year }}</h5>
            {% if names %}
            <ul class="list-group">
                {% for name in names %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ name }}
                    <form method="post" action="{{ url_for('delete_candidate') }}">
                        <input type="hidden" name="year" value="{{ year }}">
                        <input type="hidden" name="name" value="{{ name }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No candidates listed for this year.</p>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        Manually Cast Vote
    </div>
    <div class="card-body">
        <form class="row g-3 align-items-end" method="post" action="{{ url_for('manual_vote') }}">
            <div class="col-md-4">
                <label for="email" class="form-label">Student Email</label>
                <input type="email" name="email" id="email" class="form-control" placeholder="student_email@student.csuniv.edu" required>
            </div>
            <div class="col-md-3">
                <label for="manual_vote_year" class="form-label">Class Year</label>
                <select name="year" id="manual_vote_year" class="form-select" required>
                    <option value="Freshman">Freshman</option>
                    <option value="Sophomore">Sophomore</option>
                    <option value="Junior">Junior</option>
                    <option value="Senior">Senior</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="candidate_name_select" class="form-label">Candidate</label>
                <select name="candidate_name" id="candidate_name_select" class="form-select" required>
                    </select>
            </div>
            <div class="col-md-3" id="write_in_wrapper" style="display: none;">
                <label for="write_in_name" class="form-label">Write-in Name</label>
                <input type="text" name="write_in_name" id="write_in_name" class="form-control">
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">Submit Vote</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Convert Jinja candidates dictionary to a JavaScript object
    const candidates = {{ candidates | tojson }};

    const yearSelect = document.getElementById('manual_vote_year');
    const candidateSelect = document.getElementById('candidate_name_select');
    const writeInWrapper = document.getElementById('write_in_wrapper');
    const writeInInput = document.getElementById('write_in_name');

    function updateCandidates() {
        const selectedYear = yearSelect.value;
        const yearCandidates = candidates[selectedYear] || [];
        
        // Clear previous options
        candidateSelect.innerHTML = '<option value="" selected disabled>Choose...</option>';
        
        // Populate new options
        yearCandidates.forEach(candidate => {
            const option = document.createElement('option');
            option.value = candidate;
            option.textContent = candidate;
            candidateSelect.appendChild(option);
        });
        
        // Add write-in option
        const writeInOption = document.createElement('option');
        writeInOption.value = 'write-in';
        writeInOption.textContent = 'Write-in...';
        candidateSelect.appendChild(writeInOption);

        // Reset write-in field
        writeInWrapper.style.display = 'none';
        writeInInput.required = false;
    }

    candidateSelect.addEventListener('change', function() {
        if (this.value === 'write-in') {
            writeInWrapper.style.display = 'block';
            writeInInput.required = true;
        } else {
            writeInWrapper.style.display = 'none';
            writeInInput.required = false;
        }
    });

    // Initial population and event listener
    yearSelect.addEventListener('change', updateCandidates);
    document.addEventListener('DOMContentLoaded', updateCandidates);
</script>
{% endblock %}